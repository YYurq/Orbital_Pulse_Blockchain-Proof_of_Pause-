name: Anchor Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Solana & Anchor
        run: |
          # Устанавливаем Solana 1.18.x (она современнее и решит конфликт с pubkey)
          sh -c "$(curl -sSfL https://release.solana.com/v1.18.12/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
          
          # Устанавливаем Anchor
          npm install -g @coral-xyz/anchor-cli@0.29.0

      - name: Build
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          
          # Ключ
          mkdir -p ~/.config/solana
          solana-keygen new --no-bip39-passphrase -o ~/.config/solana/id.json || echo "exists"
          
          # Генерируем лок
          cargo generate-lockfile
          
          # РЕШАЕМ ТУ САМУЮ ПЕРВУЮ ПРОБЛЕМУ:
          # Заставляем borsh-derive быть версии 1.5.1, но borsh оставить 0.10
          # Это предотвратит требование Rust 1.77
          cargo update -p borsh --precise 0.10.3 || echo "ok"
          
          # Самое важное: если прилетает borsh 1.6, мы его давим
          cargo update -p borsh-derive --precise 1.5.0 || echo "ok"
          
          anchor build
